# Vectorizing Data with pgai in Timescale and Querying it with Hasura

## Outcomes

- [ ] Create a sample project that highlights the power of Timescale's pgai extension, demonstrating the ability to
      vectorize data within PostgreSQL.
- [ ] Create a sample project that highlights the power of Hasura DDN Pacha, allowing realtime authorized queries across
      data sources.

## Project architecture

The Docker compose provides the best overview of what we'll be building:

```yaml
services:
  ollama:
    image: ollama/ollama
    ports:
      - "11435:11434"
    volumes:
      - ollama_data:/root/.ollama

  timescaledb:
    image: timescale/timescaledb:latest-pg16
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: changelog_db
    volumes:
      - timescale_data:/var/lib/postgresql/data
      - ./init-scripts/timescaledb:/docker-entrypoint-initdb.d
    depends_on:
      - ollama

  mongodb:
    image: mongo:latest
    container_name: mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db

  mongo-seed:
    build:
      context: ./init-scripts/mongodb/
      dockerfile: Dockerfile
    links:
      - mongodb
    depends_on:
      - mongodb

volumes:
  ollama_data:
  timescale_data:
  mongo_data:
```

However, this will also be our directory structure:

```tree
timescale-pacha/
├── docker-compose.yaml
├── hasura/
│   ├── pacha/
├── init-scripts/
│   ├── mongodb/
│   │   └── Dockerfile
│   │   └── pull_requests.json
│   └── timescaledb/
│       └── seed.sql
└── README.md
```

### PostgreSQL

#### Developer table

```sql
CREATE TABLE developer (
    id bigint not null primary key generated by default as identity,
    name text NOT NULL,
    email text UNIQUE NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

#### Repository table

```sql
CREATE TABLE repository (
    id int not null PRIMARY KEY generated by default as identity,
    name text UNIQUE NOT NULL,
    description text,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

#### Commit table

```sql
CREATE TABLE commit (
    id int not null PRIMARY KEY generated by default as identity,
    developer_id INTEGER REFERENCES developer(id),
    repository_id INTEGER REFERENCES repository(id),
    hash text UNIQUE NOT NULL,
    message text NOT NULL,
    description text NOT NULL,
    commit_time TIMESTAMPTZ NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

### MongoDB

#### Pull Requests collection

TODO: Update

### Pacha

Which has DDN under-the-hood.

## Getting started

### Step 1. Clone the repo

```sh
git clone https://github.com/Birmingham-AI/realtime-vector.git
```

### Step 2. Build and run the images

From the root of the project, and with the Docker daemon running, build the images and start them up in the background:

```sh
docker compose up -d
```

You can run `docker ps` to check and see that all services are running. Then, when done, run `docker compose down` to
stop them.

### Step 3. Interact with your DBs

You can access Timescale using `psql` by running this command:

```sh
psql postgresql://postgres:postgres@localhost:5432/trading_db
```

And MongoDB by running:

```sh
mongosh mongodb://127.0.0.1:27017/github_proxy
```

Then, query the `pull_requests` collection by running:

```sh
db.pull_requests.find()
```
